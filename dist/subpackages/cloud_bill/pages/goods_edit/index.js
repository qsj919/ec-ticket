"use strict";require("../../sub-vendors.js");require("../../vod"),(wx.webpackJsonp=wx.webpackJsonp||[]).push([[4343],{82974:function(e,o,n){var a=n(32180),i=n(66058),t=n(18453),s=n(57543),r=n(77886),c=n(33661),l=n(12742),d=n(22700),u=n(95333),g=n(14175),m=n(3701),p=n(92954),f=n.n(p),_=n(67294),h=n(71515),v=n(75508),Z=n(59132),x=n(63056),w=n(37001),I=n(35314),k=n(2021),y=n(6420),N=n(41115),b=n(31254),U=n(70200),V=n(75150),j="index-module__container___g5v5b",D="index-module__image_add___vGE6c",C="index-module__media_content___MiA1e",T="index-module__image_add__icon___c0Wvp",M="index-module__image_add__text___yg78w",S="index-module__image___Z_KHw",F="index-module__image__image___nRV_j",P="index-module__image__del_icon___cRaxD",J="index-module__image__edit___rWbEd",L="index-module__action_view___M3J1_",A="index-module__action_view___right___sEo3q",G="index-module__title___SxQFj",O=function(e,o,n,a){var i=new Array(e.length).fill(void 0);I.Z.log("开始异步上传，图片长度:".concat(e.length));var t=0,c=0,l=!1;e.forEach(function(){var d=(0,r.Z)((0,s.Z)().mark((function r(d,u){var g,m;return(0,s.Z)().wrap((function(s){for(;;)switch(s.prev=s.next){case 0:if(!d.docId){s.next=5;break}i[u]=d.docId,i.every((function(e){return e&&e.length>0}))&&i.length===e.length&&(l||(a(),l=!0),n(i.filter((function(e){return!Number.isNaN(Number(e))})),c,t)),s.next=14;break;case 5:if(!(0,N.$L)()){s.next=9;break}g=d.url,s.next=13;break;case 9:return s.next=11,f().compressImage({src:d.url,quality:60});case 11:m=s.sent,g=m.tempFilePath;case 13:f().uploadFile({url:o,filePath:g,name:"img",withCredentials:!1}).then((function(o){var s=o.data;Number.isNaN(Number(s))&&(I.Z.error("图片上传失败:".concat(s)),t+=1,c-=1),c+=1,i[u]=s,l||(a(),l=!0),i.every((function(e){return e&&e.length>0}))&&i.length===e.length&&n(i.filter((function(e){return!Number.isNaN(Number(e))})),c,t)}));case 14:case"end":return s.stop()}}),r)})));return function(e,o){return d.apply(this,arguments)}}())},E=n(21379),q=n(85893),B=function(e){(0,u.Z)(n,e);var o=(0,g.Z)(n);function n(){var e;(0,c.Z)(this,n);for(var a=arguments.length,l=new Array(a),u=0;u<a;u++)l[u]=arguments[u];return e=o.call.apply(o,[this].concat(l)),(0,m.Z)((0,d.Z)(e),"state",{videoInfo:{},isVideoVisible:!1}),(0,m.Z)((0,d.Z)(e),"coverDocId",void 0),(0,m.Z)((0,d.Z)(e),"images",[]),(0,m.Z)((0,d.Z)(e),"backTimer",null),(0,m.Z)((0,d.Z)(e),"onChooseImage",(function(o,n){e.images=o})),(0,m.Z)((0,d.Z)(e),"onDeleteImage",(function(o,n){e.images=o})),(0,m.Z)((0,d.Z)(e),"onImageChange",(function(o){e.images=o,e.coverDocId||(e.coverDocId=o[0].url)})),(0,m.Z)((0,d.Z)(e),"uploadSuccess",(0,r.Z)((0,s.Z)().mark((function o(){return(0,s.Z)().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:x.Z.showToast("图片视频更改成功"),e.backTimer=setTimeout((function(){f().navigateBack()}),1500);case 2:case"end":return o.stop()}}),o)})))),(0,m.Z)((0,d.Z)(e),"onSaveClick",(0,r.Z)((0,s.Z)().mark((function o(){var n,a,r,c,l,d,u;return(0,s.Z)().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(0!==e.images.length){o.next=2;break}return o.abrupt("return",x.Z.showToast("请选择至少一张图片"));case 2:f().showLoading({mask:!0,title:"图片上传中..."}),a=e.images[0].url,e.coverDocId,r=e.props.docUploadUrl,c=(0,t.Z)(e.images),l=e.state.videoInfo,d=(0,y.JU)(null===(n=f().getCurrentInstance)||void 0===n?void 0:n.call(f())),u=d.styleId;try{O(c,r,(function(o,n,t){w.Z.getDispatch()({type:"goodsManage/updateGoodsMedias",payload:(0,i.Z)((0,i.Z)({docIds:o},l),{},{newDocNum:n,failDocNum:t,pk:u})}),w.Z.getDispatch()({type:"goodsManage/updateGoodsImageLocal",payload:{url:a,spuId:u}}),e.uploadSuccess()}),(function(){}))}catch(e){f().hideLoading(),I.Z.log("上传图片失败：".concat(e.message||e.errMsg)),x.Z.showToast(e.message||e.errMsg)}case 10:case"end":return o.stop()}}),o)})))),(0,m.Z)((0,d.Z)(e),"uploadImg",(0,r.Z)((0,s.Z)().mark((function o(){var n,a;return(0,s.Z)().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return n=e.props.docUploadUrl,o.next=3,Promise.all(e.images.map((function(e){return e.docId?new Promise((function(o){o(e.docId)})):f().uploadFile({url:n,filePath:e.url,name:"img"}).then((function(e){return e.data}))})));case 3:return a=o.sent,o.abrupt("return",a);case 5:case"end":return o.stop()}}),o)})))),(0,m.Z)((0,d.Z)(e),"deleteVideo",(function(){e.setState({videoInfo:{fileId:-1,videoUrl:""}})})),(0,m.Z)((0,d.Z)(e),"onVideoClick",(function(){f().navigateTo({url:"/subpackages/cloud_bill/pages/video_player_page/index?videoUrl=".concat(e.state.videoInfo.videoUrl)})})),(0,m.Z)((0,d.Z)(e),"onUploadClick",(function(){f().chooseVideo({compressed:!1,maxDuration:b.aF,success:function(o){if(o.duration>b.aF)return x.Z.showToast("视频长度不能超过".concat(b.aF,"秒"),2e3);console.log(o),I.Z.log("视频元信息：".concat(JSON.stringify(o))),e.uploadVideo(o)}})})),(0,m.Z)((0,d.Z)(e),"uploadVideo",(function(o,n){if(!e.props.sign)return e.props.dispatch({type:"goodsManage/fetchTXCloudSign"}),x.Z.showToast("请重进页面再试");f().showLoading({title:"视频上传中..."}),I.Z.log("开始上传视频，文件信息：".concat(JSON.stringify(o)));E.Z.start({mediaFile:o,getSignature:function(o){return o(e.props.sign)},mediaName:"".concat((0,y.uN)(),"_from_mp"),coverFile:n,progress:function(e){f().showLoading({title:"视频上传中(".concat(Math.floor(100*e.percent),"%)")})},finish:function(o){f().hideLoading(),I.Z.log("上传结束，文件信息：".concat(JSON.stringify(o))),x.Z.showToast("视频上传成功"),e.setState({videoInfo:{videoUrl:o.videoUrl,coverUrl:o.coverUrl,fileId:o.fileId}})},error:function(e){f().hideLoading(),x.Z.showToast(e.errMsg||e.message),I.Z.log("上传视频失败: ".concat(e.errMsg||e.message,"，").concat(JSON.stringify(e)))}})})),(0,m.Z)((0,d.Z)(e),"renderActionView",(function(){return(0,q.jsx)(h.View,{className:L,children:(0,q.jsx)(h.View,{className:A,onClick:e.onSaveClick,children:"保存"})})})),e}return(0,l.Z)(n,[{key:"componentDidShow",value:function(){(0,N.ZT)("相册管理")}},{key:"componentDidMount",value:function(){var e,o=(0,y.JU)(null===(e=f().getCurrentInstance)||void 0===e?void 0:e.call(f())).styleId;this.props.dispatch({type:"goodsManage/resetDetail"}),this.props.dispatch({type:"goodsManage/fetchGoodsDetail",payload:{spuId:o}})}},{key:"componentDidUpdate",value:function(e){var o=this.props.goodsData.videoUrl;!e.goodsData.videoUrl&&o&&this.setState({videoInfo:{videoUrl:o}})}},{key:"componentWillUnmount",value:function(){this.backTimer&&clearTimeout(this.backTimer)}},{key:"render",value:function(){var e=this.props,o=e.imagesFromProps,n=e.loading,a=e.goodsData,i=this.state,t=i.videoInfo,s=(i.isVideoVisible,!t.videoUrl),r=!a.coverUrl||t.fileId?U:a.coverUrl;return(0,q.jsxs)(h.View,{className:j,children:[(0,q.jsx)(h.View,{className:"flex1 scroll",style:"background-color:#f7f7f7;",children:n?(0,q.jsx)(h.View,{className:"aic jcc",style:{height:"100%"},children:(0,q.jsx)(Z.AtActivityIndicator,{size:100})}):(0,q.jsxs)(h.View,{children:[(0,q.jsxs)(h.View,{className:C,children:[(0,q.jsx)(h.View,{className:G,children:"上传视频"}),s?(0,q.jsxs)(h.View,{className:D,style:"background-color: white;",onClick:this.onUploadClick,children:[(0,q.jsx)(h.Image,{className:T,src:k.Z.relay.add}),(0,q.jsx)(h.Text,{className:M,children:"添加视频"})]}):(0,q.jsxs)(h.View,{className:S,children:[(0,q.jsx)(h.Image,{className:F,onClick:this.onVideoClick,src:r,mode:"aspectFill"}),(0,q.jsx)(h.Image,{className:P,src:k.Z.relay.close,onClick:this.deleteVideo}),(0,q.jsx)(h.View,{className:J,onClick:this.onUploadClick,children:"更换视频"})]})]}),(0,q.jsxs)(h.View,{className:C,children:[(0,q.jsx)(h.View,{className:G,style:{marginTop:"8px"},children:"上传图片"}),(0,q.jsx)(V.Z,{onImageChange:this.onImageChange,defaultImages:o})]})]})}),this.renderActionView()]})}}]),n}(_.PureComponent),W=(0,v.$j)((function(e){var o=e.goodsManage,n=e.loading,a=o.goodsDetail,i=a.allImgUrlBig,t=a.fileId,s=i.split(","),r=t.split(","),c=t?s.map((function(e,o){return{url:e,docId:r[o]}})):[];return{docUploadUrl:o.docUploadUrl,imagesFromProps:c,goodsData:a,loading:n.effects["goodsManage/fetchGoodsDetail"]&&n.effects["goodsManage/fetchGoodsDetail"].loading,sign:o.sign}}))(B);Page((0,a.createPageConfig)(W,"subpackages/cloud_bill/pages/goods_edit/index",{root:{cn:[]}},{navigationBarTitleText:"相册管理"}||{}))}},function(e){e.O(0,[666,1772,2107,1216,8592],(function(){return o=82974,e(e.s=o);var o}));e.O()}]);