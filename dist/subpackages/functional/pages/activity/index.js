"use strict";require("../../sub-vendors.js");(wx.webpackJsonp=wx.webpackJsonp||[]).push([[7968],{8486:function(i,t,e){var a=e(32180),_=e(66058),n=e(33661),s=e(12742),c=e(22700),o=e(95333),l=e(14175),r=e(3701),d=e(92954),u=e.n(d),v=e(67294),m=e(71515),f=e(29748),h=e(63056),x=e(75508),y=e(94184),p=e.n(y),w=e(6420),g=e(80170),b=e(24962),Z="https://webdoc.hzecool.com/webCdn/weapp/ec-ticket/src/subpackages/functional/pages/activity/images/25bdd4efbc9229fd7cb3..png",C={animation:"index-module__animation___o08SF",scaleInOut:"index-module__scaleInOut___w463_",bg:"index-module__bg___XGrBn",activity:"index-module__activity___fitos",activity__disc:"index-module__activity__disc___ox15a",activity__disc__bg:"index-module__activity__disc__bg___kCK0W",activity__disc__canvas:"index-module__activity__disc__canvas___zHTbk","activity__disc__canvas--start":"index-module__activity__disc__canvas--start___AG1h3","activity__disc__canvas--result--1":"index-module__activity__disc__canvas--result--1___pPxNu","activity__disc__canvas--result--2":"index-module__activity__disc__canvas--result--2___xFNDZ","activity__disc__canvas--result--3":"index-module__activity__disc__canvas--result--3___ADLYs","activity__disc__canvas--result--4":"index-module__activity__disc__canvas--result--4___bhfYE","activity__disc__canvas--result--5":"index-module__activity__disc__canvas--result--5___xBJP4","activity__disc__canvas--result--6":"index-module__activity__disc__canvas--result--6___d8z4J","activity__disc__canvas--result--7":"index-module__activity__disc__canvas--result--7___H2BmM","activity__disc__canvas--result--8":"index-module__activity__disc__canvas--result--8___wEiq7",activity__disc__button:"index-module__activity__disc__button___x0389",activity__info:"index-module__activity__info___kCuBc",activity__info__count:"index-module__activity__info__count___MTRt8",activity__info__record:"index-module__activity__info__record___Vb2Us",activity__info__rule__title:"index-module__activity__info__rule__title___Ze7sG",activity__info__rule__details:"index-module__activity__info__rule__details___gjqyk",activity__info__rule__detail:"index-module__activity__info__rule__detail___h0zpO",activity__info__rule__subtitle:"index-module__activity__info__rule__subtitle___imUgl",center:"index-module__center___Pi6Ed",rotateLoop:"index-module__rotateLoop___cE5y7"},j=e(1942),I=e(19806),k=e(52131),V=e(53252),N="index-module__container___BXlnM",z="index-module__title___F67j_",P="index-module__warn___eN2by",S="index-module__qr___f2Xgi",M="index-module__follow___rnBM3",T="index-module__follow_tip___5F8Pa",D="index-module__follow_tip_ex___TAKKR",F="index-module__buttons___xcQQu",A="index-module__btn___C9Yq5",B="index-module__btn--left____IQxS",U=e(85893),R=function(i){(0,o.Z)(e,i);var t=(0,l.Z)(e);function e(){var i;(0,n.Z)(this,e);for(var a=arguments.length,_=new Array(a),s=0;s<a;s++)_[s]=arguments[s];return i=t.call.apply(t,[this].concat(_)),(0,r.Z)((0,c.Z)(i),"onSaveClick",(function(){u().downloadFile({url:V.Z.followQrUrlFromAct,success:function(i){u().saveImageToPhotosAlbum({filePath:i.tempFilePath,success:function(i){h.Z.showToast("图片保存成功")},fail:function(i){i.errMsg.includes("auth")&&h.Z.showToast("请打开相册权限或长按图片保存")}})},fail:function(i){h.Z.showToast("图片保存失败，请尝试长按保存")}})})),i}return(0,s.Z)(e,[{key:"render",value:function(){return(0,U.jsx)(I.Z,(0,_.Z)((0,_.Z)({},this.props),{},{containerClass:"bg_trans",direction:k.n.Center,maxHeight:100,children:(0,U.jsxs)(m.View,{className:N,children:[(0,U.jsx)(m.View,{className:z,children:"提醒"}),(0,U.jsxs)(m.View,{className:P,children:[(0,U.jsx)(m.View,{children:"活动将在".concat(this.props.startDate,"至").concat(this.props.endDate,"期间开启")}),(0,U.jsx)(m.View,{children:"敬请期待"})]}),(0,U.jsx)(m.Image,{src:V.Z.followQrUrlFromAct,className:S,showMenuByLongpress:!0}),(0,U.jsx)(m.View,{className:M,children:"扫码关注公众号"}),(0,U.jsx)(m.View,{className:T,children:"我们会在活动开始时候提醒您"}),(0,U.jsx)(m.View,{className:D,children:"如需咨询活动信息，可通过公众号内与我们联系"}),(0,U.jsxs)(m.View,{className:F,children:[(0,U.jsx)(m.View,{className:p()(A,B),onClick:this.props.onRequestClose,children:"关闭"}),(0,U.jsx)(m.View,{className:A,onClick:this.onSaveClick,children:"保存到相册"})]})]})}))}}]),e}(v.PureComponent),E=function(i){(0,o.Z)(e,i);var t=(0,l.Z)(e);function e(){var i;(0,n.Z)(this,e);for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];return i=t.call.apply(t,[this].concat(s)),(0,r.Z)((0,c.Z)(i),"state",{rotating:!1,prize:null,prizes:[],rules:[],leftCount:0,isPrizeModalVisible:!1,cooldown:!1,isFolllowModalVisible:!1,flag:0,drawStartDate:"",drawEndDate:""}),(0,r.Z)((0,c.Z)(i),"canvasCtx",void 0),(0,r.Z)((0,c.Z)(i),"timer",void 0),(0,r.Z)((0,c.Z)(i),"timer1",void 0),(0,r.Z)((0,c.Z)(i),"drawCanvas",(function(){var t=u().getSystemInfoSync().pixelRatio,e=void 0===t?2:t;u().createSelectorQuery().select("#canvas").node((function(t){var a=580*e,_=580*e,n=a/2;t.node.width=a,t.node.height=_;var s=t.node.getContext("2d");i.canvasCtx=s;var c=i.state.prizes,o=a/2,l=_/2,r=360/c.length;c.forEach((function(i,a){var _=t.node.createImage();_.src=i.docId,_.onload=function(t){s.save(),s.beginPath(),s.moveTo(o,l),s.translate(o,l),s.rotate(Math.PI/180*a*r),s.moveTo(0,0),s.arc(0,0,n,Math.PI/180*(-90-r/2),Math.PI/180*(r/2-90)),s.textAlign="center",s.fillStyle=a%2==0?"white":"yellow",s.fill(),s.fillStyle="black",s.font="500 ".concat(20*e,"px  sans-serif"),s.fillText(i.name.slice(0,4),0,-140*e),s.fillText(i.name.slice(4),0,-110*e),s.drawImage(_,-48*e,-260*e,96*e,96*e),s.restore()},_.onerror=function(i){console.log(i,"eee")}}))})).exec()})),(0,r.Z)((0,c.Z)(i),"fetchActivityDetail",(function(){var t,e=(0,w.JU)(null===(t=u().getCurrentInstance)||void 0===t?void 0:t.call(u())).activityId;return(0,f.Rt)(e).then((function(t){var e=t.data;i.setState((0,_.Z)({},e))}))})),(0,r.Z)((0,c.Z)(i),"onGetUserInfo",(function(t){if(!i.props.sessionId){i.props.isLogining&&h.Z.showToast("登录中，请稍后");var e=t.detail,a=e.iv,_=e.encryptedData;if(a&&_)return u().showLoading({title:"登录中..."}),i.props.dispatch({type:"user/login"}).then((function(){u().hideLoading(),i.onStartBtnClick()}));h.Z.showToast("请先登录")}})),(0,r.Z)((0,c.Z)(i),"onStartBtnClick",(function(){var t,e=i.state,a=e.drawStartDate,_=e.drawEndDate;if(2!==i.state.flag){if(!i.state.rotating&&i.props.sessionId&&!i.state.cooldown){i.setState({rotating:!0,prize:null});var n=(0,w.JU)(null===(t=u().getCurrentInstance)||void 0===t?void 0:t.call(u())).activityId;(0,f.i6)(n).then((function(t){var e=t.data;g.Z.track(b.ZP.joinPrizeActivity),i.timer=setTimeout((function(){i.setState((function(i){return{cooldown:!0,rotating:!1,prize:e,leftCount:i.leftCount-1}})),i.timer1=setTimeout((function(){i.setState({isPrizeModalVisible:!0,cooldown:!1})}),1100)}),1500)})).catch((function(){i.setState({rotating:!1})}))}}else"1"===i.props.subscribe?h.Z.showToast("活动开始时间为".concat(a,"至").concat(_)):i.setState({isFolllowModalVisible:!0})})),(0,r.Z)((0,c.Z)(i),"hidePrizeModal",(function(){i.setState({isPrizeModalVisible:!1})})),(0,r.Z)((0,c.Z)(i),"hideFollowModal",(function(){i.setState({isFolllowModalVisible:!1})})),(0,r.Z)((0,c.Z)(i),"onPrizeRecordClick",(function(){var i,t=(0,w.JU)(null===(i=u().getCurrentInstance)||void 0===i?void 0:i.call(u())).activityId;u().navigateTo({url:"/subpackages/functional/pages/prize_record/index?activityId=".concat(t)})})),i}return(0,s.Z)(e,[{key:"componentDidMount",value:function(){var i=this;this.fetchActivityDetail().then((function(){i.drawCanvas()}))}},{key:"componentDidUpdate",value:function(i){!i.sessionId&&this.props.sessionId&&this.fetchActivityDetail().then((function(){}))}},{key:"componentWillUnmount",value:function(){this.timer&&clearTimeout(this.timer),this.timer1&&clearTimeout(this.timer1)}},{key:"render",value:function(){var i,t=this.state,e=t.rotating,a=t.prize,_=t.rules,n=t.leftCount,s=t.isPrizeModalVisible,c=t.prizes,o=t.isFolllowModalVisible,l=t.drawStartDate,d=t.drawEndDate,u=a?a.name:"",v=c.findIndex((function(i){return a&&i.id===a.activityPrizeId})),f=!this.props.sessionId,h=n>0&&!e;return(0,U.jsxs)(m.View,{className:C.activity,children:[(0,U.jsx)(m.Image,{className:C.bg,src:"https://webdoc.hzecool.com/webCdn/weapp/ec-ticket/src/subpackages/functional/pages/activity/images/4b16333ad61e1498323c..png"}),(0,U.jsxs)(m.View,{className:C.activity__disc,children:[(0,U.jsx)(m.Image,{src:"https://webdoc.hzecool.com/webCdn/weapp/ec-ticket/src/subpackages/functional/pages/activity/images/ba20726d029495e2b6ab..png",className:C.activity__disc__bg}),(0,U.jsx)(m.View,{className:C.center,children:(0,U.jsx)(m.View,{className:p()(C.activity__disc__canvas,(i={},(0,r.Z)(i,C["activity__disc__canvas--start"],e),(0,r.Z)(i,C["activity__disc__canvas--result--".concat(v)],v>0&&!e),i)),children:(0,U.jsx)(m.Canvas,{className:p()(C.activity__disc__canvas),id:"canvas",canvasId:"canvas",type:"2d"})})}),f?(0,U.jsx)(m.Button,{openType:"getUserInfo",className:p()(C.activity__disc__button,(0,r.Z)({},C.animation,h)),onClick:this.onStartBtnClick,onGetUserInfo:this.onGetUserInfo,children:(0,U.jsx)(m.Image,{src:Z,style:{width:"100%",height:"100%"}})}):(0,U.jsx)(m.Image,{src:Z,className:p()(C.activity__disc__button,(0,r.Z)({},C.animation,h)),onClick:this.onStartBtnClick})]}),(0,U.jsxs)(m.View,{className:C.activity__info,children:[(0,U.jsx)(m.View,{className:C.activity__info__count,children:"您还有".concat(n,"次抽奖机会")}),(0,U.jsx)(m.View,{className:C.activity__info__record,onClick:this.onPrizeRecordClick,children:"我的中奖纪录"}),(0,U.jsxs)(m.View,{className:C.activity__info__rule,children:[(0,U.jsx)(m.View,{className:C.activity__info__rule__title,children:"活动规则"}),(0,U.jsx)(m.View,{className:C.activity__info__rule__details,children:_.map((function(i){return(0,U.jsxs)(m.View,{className:C.activity__info__rule__detail,children:[(0,U.jsx)(m.View,{className:C.activity__info__rule__subtitle,children:i.title}),(0,U.jsx)(m.View,{children:i.content.map((function(i){return(0,U.jsx)(m.View,{children:i},i)}))})]},i.title)}))})]})]}),(0,U.jsx)(j.Z,{visible:s,prize:u,activityPrizeId:a?a.id:0,code:a?a.prizeCode:"",onRequestClose:this.hidePrizeModal,expireDate:a?a.expireDate:""}),(0,U.jsx)(R,{visible:o,onRequestClose:this.hideFollowModal,startDate:l,endDate:d})]})}}]),e}(v.PureComponent),L=(0,x.$j)((function(i){var t=i.user;return{sessionId:t.sessionId,isLogining:t.logining,subscribe:t.subscribe}}))(E);Page((0,a.createPageConfig)(L,"subpackages/functional/pages/activity/index",{root:{cn:[]}},{navigationBarTitleText:"限量送好礼"}||{}))}},function(i){i.O(0,[9860,2107,1216,8592],(function(){return t=8486,i(i.s=t);var t}));i.O()}]);