"use strict";require("../../sub-vendors.js");(wx.webpackJsonp=wx.webpackJsonp||[]).push([[5908],{50467:function(e,t,i){var a=i(32180),s=i(18453),c=i(66058),n=i(33661),o=i(12742),r=i(22700),l=i(95333),d=i(14175),g=i(3701),h=i(92954),u=i.n(h),p=i(67294),k=i(75508),Z=i(71515),m=i(44559),_=i(1695),L=i(65915),f=i(6420),v=i(29748),w=i(10162),S=i(22381),I=i(48882),N=i(80170),C=i(24962),x=i(86720),b=i(85893),V=[{label:"小票"},{label:"商品"}],j=function(e){(0,l.Z)(i,e);var t=(0,d.Z)(i);function i(e){var a,o;(0,n.Z)(this,i),o=t.call(this,e),(0,g.Z)((0,r.Z)(o),"searchValue",""),(0,g.Z)((0,r.Z)(o),"goodsListPageNo",1),(0,g.Z)((0,r.Z)(o),"ticketListPageNo",1),(0,g.Z)((0,r.Z)(o),"searched",!1),(0,g.Z)((0,r.Z)(o),"onTabsClick",(function(e){0===e?N.Z.track(C.ZP.ticketSearchTabClickTicket):1===e&&N.Z.track(C.ZP.ticketSearchTabClickGoods),o.setState({activeIndex:e},(function(){o.searchValue&&o.onSearch()}))})),(0,g.Z)((0,r.Z)(o),"onSearchInput",(function(e){o.searchValue=e})),(0,g.Z)((0,r.Z)(o),"onSearch",(function(){var e=o.state.activeIndex,t={searchKey:o.searchValue,pageNo:1};0===e?o.fetchUnionTicketList():o.getEsDresListData(t),N.Z.track(C.ZP.ticketSearchClick),o.searched=!0})),(0,g.Z)((0,r.Z)(o),"onClearSearch",(function(){o.searchValue="",o.goodsListPageNo=1,o.ticketListPageNo=1,o.setState({ticketList:[],goodsDataList:[],ticketCount:0})})),(0,g.Z)((0,r.Z)(o),"onCancelClick",(function(){u().navigateBack()})),(0,g.Z)((0,r.Z)(o),"fetchUnionTicketList",(function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e?o.ticketListPageNo+=1:o.ticketListPageNo=1,o.setState({isLoading:!0}),(0,v.__)({pageNo:o.ticketListPageNo,searchKey:o.searchValue}).then((function(t){var i=t.data;o.setState((function(t){var a=t.ticketCount;return 1===o.ticketListPageNo?a=i.bills.length:a+=i.bills.length,{ticketList:(0,w.G7)(i.bills,e?t.ticketList:[]),ticketCount:a,isLoading:!1}}))})).catch((function(t){console.log(t),o.setState({isLoading:!1}),e&&o.ticketListPageNo--}))})),(0,g.Z)((0,r.Z)(o),"getEsDresListData",(function(e){o.setState({isLoading:!0}),(0,v.Hp)((0,c.Z)({},e)).then((function(t){1===e.pageNo?o.setState({goodsDataList:t.data.rows,isLoading:!1}):o.setState((function(e){return{goodsDataList:[].concat((0,s.Z)(e.goodsDataList),(0,s.Z)(t.data.rows)),isLoading:!1}}))})).catch((function(t){o.setState({isLoading:!1}),1!==e.pageNo&&o.goodsListPageNo--}))})),(0,g.Z)((0,r.Z)(o),"onCheckDetailClick",(function(e){var t=o.props.sessionId,i="pk=".concat(e.billId,"&sn=").concat(e.sn,"&epid=").concat(e.epid,"&sessionId=").concat(t,"&shopId=").concat(e.shopId,"&type=",1);u().navigateTo({url:"/pages/eTicketDetail/landscapeModel?".concat(i)})})),(0,g.Z)((0,r.Z)(o),"getQuery",(function(e){return"logo=".concat(e.logoUrl,"&shopName=").concat(e.shopName,"&cloudBillFlag=").concat(e.cloudBillFlag,"&epid=").concat(e.epid,"&sn=").concat(e.sn,"&mpErpId=").concat(e.id)})),(0,g.Z)((0,r.Z)(o),"goodsItemClick",(function(e){var t=o.props.shopList.find((function(t){return String(t.shopid)===String(e.shopId)&&String(t.epid)===String(e.epid)&&String(t.sn)===String(e.sn)}));o.props.dispatch({type:"imageDownload/fetchImageUrlsFormatData",payload:{mpErpId:t.id,styleIds:e.styleId,sourceData:[(0,c.Z)((0,c.Z)({},e),{},{allImgUrlBig:e.allImgUrlBig||e.imgUrl,tenantSpuId:e.styleId})]}}),N.Z.track(C.ZP.goodsClick),u().navigateTo({url:"/subpackages/functional/pages/download_image/index?".concat(o.getQuery(t))})})),(0,g.Z)((0,r.Z)(o),"onShopClick",(function(e){var t=o.props.shopList.find((function(t){return String(t.shopid)===String(e.shopId)&&String(t.epid)===String(e.epid)&&String(t.sn)===String(e.sn)}));u().navigateTo({url:"/subpackages/ticket/pages/ticket_home/index?id=".concat(t.id,"&type=2")})})),(0,g.Z)((0,r.Z)(o),"onScrollToLower",(function(){var e=o.state,t=e.activeIndex,i=e.ticketCount;if(0===t)i>=20*o.ticketListPageNo&&o.fetchUnionTicketList(!0);else if(o.state.goodsDataList.length>=20*o.goodsListPageNo){o.goodsListPageNo+=1;var a={pageNo:o.goodsListPageNo,searchKey:o.searchValue};o.getEsDresListData(a)}}));var l=(0,f.JU)(null===(a=u().getCurrentInstance)||void 0===a?void 0:a.call(u())).activeIndex;return o.state={activeIndex:Number(l),ticketList:[],goodsDataList:[],ticketCount:0,isLoading:!1},o}return(0,o.Z)(i,[{key:"render",value:function(){var e=this,t=this.state,i=t.activeIndex,a=t.ticketList,s=t.goodsDataList,c=t.isLoading;return(0,b.jsxs)(Z.View,{className:"ticket_search_view",children:[(0,b.jsxs)(Z.View,{className:"ticket_search_view__header",children:[(0,b.jsxs)(Z.View,{className:"ticket_search_view__header___searchview",children:[(0,b.jsx)(m.Z,{placeholder:"输入批次号、商品名称、款号",backgroundColor:"#fff",onSearchClick:this.onSearch,onInput:this.onSearchInput,onClearSearchClick:this.onClearSearch,focus:!0}),(0,b.jsx)(Z.View,{className:"searchview_cancel",onClick:this.onSearch,children:"搜索"})]}),(0,b.jsx)(Z.View,{className:"ticket_search_view__header___tabsview",children:(0,b.jsx)(_.Z,{data:V,activeIndex:i,margin:300,underlineWidth:40,underlineHeight:6,tabsBackgroundImage:"linear-gradient(to right, #FF788F, #E62E4D)",onTabItemClick:this.onTabsClick})})]}),(0,b.jsxs)(Z.ScrollView,{className:"ticket_search_view__content",scrollY:!0,lowerThreshold:500,onScrollToLower:this.onScrollToLower,children:[0===i&&(0,b.jsx)(Z.View,{className:"ticket_list_content",children:a.map((function(t){return(0,b.jsxs)(Z.View,{children:[(0,b.jsxs)(Z.View,{className:"ticket_list_content__shop",children:[(0,b.jsx)(Z.Image,{className:"ticket_list_content__avatar",src:t.shopLogo||I}),t.shopName]}),t.bills.map((function(t){return(0,b.jsx)(S.Z,{type:1,item:t,onItemClick:e.onCheckDetailClick},t.billId)}))]},t.shopId)}))}),1===i&&(0,b.jsx)(Z.View,{className:"ticket_list_content",children:(0,b.jsx)(L.Z,{onItemClick:this.goodsItemClick,emptyView:!1,sortViewVisible:!0,goodsData:s,onShopClick:this.onShopClick})}),!c&&this.searched&&(0===i&&0===a.length||1===i&&0==s.length)&&(0,b.jsxs)(Z.View,{className:"empty_view",children:[(0,b.jsx)(Z.Image,{src:x,className:"empty_view_image"}),(0,b.jsx)(Z.View,{className:"empty_view_title",children:"没搜到结果"}),(0,b.jsx)(Z.View,{className:"empty_view_label",children:"换个关键字再搜搜吧"})]})]}),c&&(0,b.jsx)(Z.Image,{src:"https://webdoc.hzecool.com/webCdn/weapp/ec-ticket/src/subpackages/ticket/images/a40192bcdebcd3671f75..gif",className:"loading_icon"})]})}}]),i}(p.Component),D=(0,k.$j)((function(e){var t=e.user,i=e.shop;return{sessionId:t.sessionId,shopList:i.list}}))(j);Page((0,a.createPageConfig)(D,"subpackages/ticket/pages/ticket_search/index",{root:{cn:[]}},{navigationBarTitleText:"搜索"}||{}))}},function(e){e.O(0,[7964,2107,1216,8592],(function(){return t=50467,e(e.s=t);var t}));e.O()}]);