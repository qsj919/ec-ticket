"use strict";(wx.webpackJsonp=wx.webpackJsonp||[]).push([[2172],{30432:function(t,e,i){t.exports=i(60605),t.exports.default=t.exports},60605:function(t,e,i){i.r(e),i.d(e,{TaroCropper:function(){return C}});var o=i(33661),r=i(12742),n=i(22700),a=i(14621),h=i(59558),s=i(95333),c=i(14175),p=i(3701),l=i(92954),u=i.n(l),g=i(71515);Taro.CanvasContext;function d(t,e,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"1.9.90";(function(t,e){t=t.split("."),e=e.split(".");for(var i=Math.max(t.length,e.length);t.length<i;)t.push("0");for(;e.length<i;)e.push("0");for(var o=0;o<i;o++){var r=parseInt(t[o]),n=parseInt(e[o]);if(r>n)return 1;if(r<n)return-1}return 0})(t.SDKVersion,o)>=0?i():e()}var f=i(85893),v=function(t){(0,s.Z)(i,t);var e=(0,c.Z)(i);function i(t){var r;return(0,o.Z)(this,i),r=e.call(this,t),(0,p.Z)((0,n.Z)(r),"systemInfo",void 0),(0,p.Z)((0,n.Z)(r),"cropperCanvasContext",void 0),(0,p.Z)((0,n.Z)(r),"cropperCutCanvasContext",void 0),(0,p.Z)((0,n.Z)(r),"imageLeft",0),(0,p.Z)((0,n.Z)(r),"imageTop",0),(0,p.Z)((0,n.Z)(r),"imageLeftOrigin",0),(0,p.Z)((0,n.Z)(r),"imageTopOrigin",0),(0,p.Z)((0,n.Z)(r),"width",0),(0,p.Z)((0,n.Z)(r),"height",0),(0,p.Z)((0,n.Z)(r),"cropperWidth",0),(0,p.Z)((0,n.Z)(r),"cropperHeight",0),(0,p.Z)((0,n.Z)(r),"imageInfo",void 0),(0,p.Z)((0,n.Z)(r),"realImageWidth",0),(0,p.Z)((0,n.Z)(r),"realImageHeight",0),(0,p.Z)((0,n.Z)(r),"scaleImageWidth",0),(0,p.Z)((0,n.Z)(r),"scaleImageHeight",0),(0,p.Z)((0,n.Z)(r),"image",void 0),(0,p.Z)((0,n.Z)(r),"touch0X",0),(0,p.Z)((0,n.Z)(r),"touch0Y",0),(0,p.Z)((0,n.Z)(r),"oldDistance",0),(0,p.Z)((0,n.Z)(r),"oldScale",1),(0,p.Z)((0,n.Z)(r),"newScale",1),(0,p.Z)((0,n.Z)(r),"lastScaleImageWidth",0),(0,p.Z)((0,n.Z)(r),"lastScaleImageHeight",0),r.update=r.update.bind((0,n.Z)(r)),r.handleOnTouchMove=r.handleOnTouchMove.bind((0,n.Z)(r)),r.handleOnTouchStart=r.handleOnTouchStart.bind((0,n.Z)(r)),r.handleOnTouchEnd=r.handleOnTouchEnd.bind((0,n.Z)(r)),r._drawCropperCorner=r._drawCropperCorner.bind((0,n.Z)(r)),r._drawCropperContent=r._drawCropperContent.bind((0,n.Z)(r)),r.systemInfo=u().getSystemInfoSync(),r.state={scale:1},r}return(0,r.Z)(i,[{key:"updateInfo",value:function(t){var e=this,i=t.width,o=t.height,r=t.cropperWidth,n=t.cropperHeight,a=t.src,h=t.fullScreen;return this.width=h?this.systemInfo.windowWidth:this._getRealPx(i),this.height=h?this.systemInfo.windowHeight:this._getRealPx(o),this.cropperWidth=this._getRealPx(r),this.cropperHeight=this._getRealPx(n),a?u().getImageInfo({src:a}).then((function(t){e.imageInfo=t;var i=t.width,o=t.height;return i/o<e.cropperWidth/e.cropperHeight?(e.scaleImageWidth=e.realImageWidth=e.cropperWidth,e.scaleImageHeight=e.realImageHeight=e.realImageWidth*o/i,e.imageLeftOrigin=e.imageLeft=(e.width-e.cropperWidth)/2,e.imageTopOrigin=e.imageTop=(e.height-e.realImageHeight)/2):(e.scaleImageHeight=e.realImageHeight=e.cropperHeight,e.scaleImageWidth=e.realImageWidth=e.realImageHeight*i/o,e.imageLeftOrigin=e.imageLeft=(e.width-e.realImageWidth)/2,e.imageTopOrigin=e.imageTop=(e.height-e.cropperHeight)/2),Promise.resolve()})):Promise.reject()}},{key:"componentDidMount",value:function(){var t=this,e=this.props,i=e.cropperCanvasId,o=e.cropperCutCanvasId;this.cropperCanvasContext=u().createCanvasContext(i,this),this.cropperCutCanvasContext=u().createCanvasContext(o,this),this.updateInfo(this.props).then((function(){t.update()})).catch((function(){t.update()}))}},{key:"_getRealPx",value:function(t){return t/750*this.systemInfo.screenWidth}},{key:"_drawCropperCorner",value:function(){var t,e,i,o=this.props.themeColor,r=10,n=(this.width-this.cropperWidth)/2,a=(this.height-this.cropperHeight)/2;this.cropperCanvasContext.beginPath(),t=this.systemInfo,e=this.cropperCanvasContext,i=o,d(t,(function(){e.setStrokeStyle(i),console.log("???")}),(function(){"string"==typeof i&&(e.strokeStyle=i),console.log("2333")})),function(t,e,i){d(t,(function(){e.setLineWidth(i)}),(function(){e.lineWidth=i}))}(this.systemInfo,this.cropperCanvasContext,2),this.cropperCanvasContext.moveTo(n,a),this.cropperCanvasContext.lineTo(n+r,a),this.cropperCanvasContext.moveTo(n,a-1),this.cropperCanvasContext.lineTo(n,a+r),this.cropperCanvasContext.moveTo(n+this.cropperWidth,a),this.cropperCanvasContext.lineTo(n+this.cropperWidth-r,a),this.cropperCanvasContext.moveTo(n+this.cropperWidth,a-1),this.cropperCanvasContext.lineTo(n+this.cropperWidth,a+r),this.cropperCanvasContext.moveTo(n,a+this.cropperHeight),this.cropperCanvasContext.lineTo(n+r,a+this.cropperHeight),this.cropperCanvasContext.moveTo(n,a+this.cropperHeight+1),this.cropperCanvasContext.lineTo(n,a+this.cropperHeight-r),this.cropperCanvasContext.moveTo(n+this.cropperWidth,a+this.cropperHeight),this.cropperCanvasContext.lineTo(n+this.cropperWidth-r,a+this.cropperHeight),this.cropperCanvasContext.moveTo(n+this.cropperWidth,a+this.cropperHeight+1),this.cropperCanvasContext.lineTo(n+this.cropperWidth,a+this.cropperHeight-r),this.cropperCanvasContext.closePath(),this.cropperCanvasContext.stroke()}},{key:"_drawCropperContent",value:function(t,e,i,o,r,n,a){this._drawCropperCorner();var h=(this.width-this.cropperWidth)/2,s=(this.height-this.cropperHeight)/2,c=(h-e)/n*o,p=(s-i)/a*r,l=this.cropperWidth/n*o,u=this.cropperHeight/a*r;this.cropperCanvasContext.drawImage(t,c,p,l,u,h,s,this.cropperWidth,this.cropperHeight),this.cropperCutCanvasContext.drawImage(t,c,p,l,u,0,0,this.cropperWidth,this.cropperHeight)}},{key:"update",value:function(){if(!this.imageInfo)return this._drawCropperCorner(),void this.cropperCanvasContext.draw();var t,e,i,o=this.imageInfo.path;this.cropperCanvasContext.drawImage(o,0,0,this.imageInfo.width,this.imageInfo.height,this.imageLeft,this.imageTop,this.scaleImageWidth,this.scaleImageHeight),this.cropperCanvasContext.beginPath(),t=this.systemInfo,e=this.cropperCanvasContext,i="rgba(0, 0, 0, 0.3)",d(t,(function(){e.setFillStyle(i)}),(function(){"string"==typeof i&&(e.fillStyle=i)})),this.cropperCanvasContext.fillRect(0,0,this.width,this.height),this.cropperCanvasContext.fill(),this._drawCropperContent(o,this.imageLeft,this.imageTop,this.imageInfo.width,this.imageInfo.height,this.scaleImageWidth,this.scaleImageHeight),this.cropperCanvasContext.draw(!1),this.cropperCutCanvasContext.draw(!1)}},{key:"componentWillReceiveProps",value:function(t,e){var o=this;return JSON.stringify(t)!=JSON.stringify(this.props)&&this.updateInfo(t).then((function(){o.update()})),(0,a.Z)((0,h.Z)(i.prototype),"componentWillReceiveProps",this)&&(0,a.Z)((0,h.Z)(i.prototype),"componentWillReceiveProps",this).call(this,t,e)}},{key:"_outsideBound",value:function(t,e){this.imageLeft=t>(this.width-this.cropperWidth)/2?(this.width-this.cropperWidth)/2:t+this.scaleImageWidth>=(this.width+this.cropperWidth)/2?t:(this.width+this.cropperWidth)/2-this.scaleImageWidth,this.imageTop=e>(this.height-this.cropperHeight)/2?(this.height-this.cropperHeight)/2:e+this.scaleImageHeight>=(this.height+this.cropperHeight)/2?e:(this.height+this.cropperHeight)/2-this.scaleImageHeight}},{key:"_oneTouchStart",value:function(t){this.touch0X=t.x,this.touch0Y=t.y}},{key:"_twoTouchStart",value:function(t,e){var i=e.x-t.x,o=e.y-t.y;this.lastScaleImageWidth=this.scaleImageWidth,this.lastScaleImageHeight=this.scaleImageHeight,this.oldDistance=Math.sqrt(i*i+o*o)}},{key:"_oneTouchMove",value:function(t){var e=t.x-this.touch0X,i=t.y-this.touch0Y;this._outsideBound(this.imageLeftOrigin+e,this.imageTopOrigin+i),this.update()}},{key:"_getNewScale",value:function(t,e,i,o){var r=o.x-i.x,n=o.y-i.y;return t+.02*(Math.sqrt(r*r+n*n)-e)}},{key:"_twoTouchMove",value:function(t,e){var i=this.props.maxScale,o=i>=1?i:1,r=this.oldScale,n=this.oldDistance;this.newScale=this._getNewScale(r,n,t,e),this.newScale<=1&&(this.newScale=1),this.newScale>o&&(this.newScale=o),this.scaleImageWidth=this.realImageWidth*this.newScale,this.scaleImageHeight=this.realImageHeight*this.newScale;var a=this.imageLeftOrigin-(this.scaleImageWidth-this.lastScaleImageWidth)/2,h=this.imageTopOrigin-(this.scaleImageHeight-this.lastScaleImageHeight)/2;this._outsideBound(a,h),this.update()}},{key:"handleOnTouchEnd",value:function(){this.oldScale=this.newScale,this.imageLeftOrigin=this.imageLeft,this.imageTopOrigin=this.imageTop}},{key:"handleOnTouchStart",value:function(t){if(this.props.src){var e=t.touches[0],i=t.touches[1];this._oneTouchStart(e),t.touches.length>=2&&this._twoTouchStart(e,i)}}},{key:"handleOnTouchMove",value:function(t){this.props.src&&(1===t.touches.length?this._oneTouchMove(t.touches[0]):t.touches.length>=2&&this._twoTouchMove(t.touches[0],t.touches[1]))}},{key:"cut",value:function(){var t=this,e=this.props,i=e.cropperCutCanvasId,o=e.fileType,r=e.quality;return new Promise((function(e,n){var a=t.$scope;u().canvasToTempFilePath({canvasId:i,x:0,y:0,width:t.cropperWidth-2,height:t.cropperHeight-2,destWidth:t.cropperWidth*t.systemInfo.pixelRatio,destHeight:t.cropperHeight*t.systemInfo.pixelRatio,fileType:o,quality:r,success:function(t){e({errMsg:t.errMsg,filePath:t.tempFilePath}),e(t)},fail:function(t){n(t)},complete:function(){}},a)}))}},{key:"render",value:function(){var t=this,e=this.props,i=e.width,o=e.height,r=e.cropperCanvasId,n=e.fullScreen,a=e.fullScreenCss,h=e.themeColor,s=e.hideFinishText,c=e.cropperWidth,p=e.cropperHeight,l=e.cropperCutCanvasId,d=e.hideCancelText,v=e.onCancel,C=e.finishText,m=e.cancelText,x=n?this.systemInfo.windowWidth:this._getRealPx(i),I=n?this.systemInfo.windowHeight:this._getRealPx(o),Z=this._getRealPx(c),T=this._getRealPx(p),w=n&&a,y=w?{}:{position:"relative"},W={background:"rgba(0, 0, 0, 0.8)",position:"relative",width:"".concat(x,"px"),height:"".concat(I,"px")},S={position:"absolute",left:"".concat((x-Z)/2,"px"),top:"".concat((I-T)/2,"px"),width:"".concat(Z,"px"),height:"".concat(T,"px")},H=null,_=null;if(!s){var k={position:"absolute",display:"inline-block",color:h,textAlign:"right",fontSize:u().pxTransform(32),bottom:u().pxTransform(30),right:u().pxTransform(30)};H=(0,f.jsx)(g.CoverView,{style:k,onClick:function(){t.cut().then((function(e){t.props.onCut&&t.props.onCut(e.filePath)})).catch((function(e){t.props.onFail&&t.props.onFail(e)}))},children:C})}if(!d){var O={position:"absolute",display:"inline-block",color:h,textAlign:"left",fontSize:u().pxTransform(32),bottom:u().pxTransform(30),left:u().pxTransform(30)};_=(0,f.jsx)(g.CoverView,{style:O,onClick:v,children:m})}return(0,f.jsxs)(g.View,{className:"taro-cropper ".concat(w?"taro-cropper-fullscreen":""),style:y,children:[(0,f.jsx)(g.Canvas,{canvasId:l,style:S,className:"cut-canvas-item ".concat(w?"cut-canvas-fullscreen":"")}),(0,f.jsx)(g.Canvas,{onTouchStart:this.handleOnTouchStart,onTouchMove:this.handleOnTouchMove,onTouchEnd:this.handleOnTouchEnd,canvasId:r,style:W,className:"canvas-item ".concat(w?"canvas-fullscreen":""),disableScroll:!0}),!s&&H,!d&&_]})}}]),i}(u().PureComponent);(0,p.Z)(v,"defaultProps",{width:750,height:1200,cropperWidth:400,cropperHeight:400,cropperCanvasId:"cropperCanvasId",cropperCutCanvasId:"cropperCutCanvasId",src:"",themeColor:"#00ff00",maxScale:3,fullScreen:!1,fullScreenCss:!1,hideFinishText:!1,hideCancelText:!0,finishText:"完成",cancelText:"取消",fileType:"jpg",quality:1,onCancel:function(){},onCut:function(){},onFail:function(){}});var C=v},63861:function(t,e,i){"use strict";var o=i(32180),r=i(57543),n=i(77886),a=i(33661),h=i(12742),s=i(22700),c=i(95333),p=i(14175),l=i(3701),u=i(92954),g=i.n(u),d=i(67294),f=i(71515),v=i(6420),C=i(75508),m=i(30432),x="index-module__bar___jv8OS",I="index-module__bar__btn___f1BmF",Z=i(85893),T=function(t){(0,c.Z)(i,t);var e=(0,p.Z)(i);function i(t){var o;return(0,a.Z)(this,i),o=e.call(this,t),(0,l.Z)((0,s.Z)(o),"taroCropper",void 0),(0,l.Z)((0,s.Z)(o),"catTaroCropper",(function(t){o.taroCropper=t})),(0,l.Z)((0,s.Z)(o),"handleCut",function(){var t=(0,n.Z)((0,r.Z)().mark((function t(e){return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return g().showLoading({title:"图片上传中"}),t.next=3,o.props.dispatch({type:"applyMiniapp/uploadImage",payload:{url:e,imgType:o.state.imgType}});case 3:g().hideLoading(),g().navigateBack();case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),(0,l.Z)((0,s.Z)(o),"handleCancel",(function(){return g().navigateBack()})),(0,l.Z)((0,s.Z)(o),"handleConfirm",(0,n.Z)((0,r.Z)().mark((function t(){var e;return(0,r.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o.taroCropper.cut();case 2:e=t.sent,o.handleCut(e.filePath);case 4:case"end":return t.stop()}}),t)})))),o.state={src:"",height:0,width:0},o}return(0,h.Z)(i,[{key:"componentDidMount",value:function(){var t,e=(0,v.JU)(null===(t=g().getCurrentInstance)||void 0===t?void 0:t.call(g())),i=e.height,o=e.width,r=e.url,n=e.imgtype;this.setState({src:r,height:Number(i),width:Number(o),imgType:n})}},{key:"render",value:function(){var t=this.state,e=(t.height,t.width,t.src);return(0,Z.jsxs)(f.View,{children:[(0,Z.jsx)(m.TaroCropper,{src:e,cropperWidth:300,cropperHeight:300,ref:this.catTaroCropper,themeColor:"#2e6be6",fullScreen:!0,onCut:this.handleCut,onCancel:this.handleCancel,hideFinishText:!0}),(0,Z.jsxs)(f.CoverView,{className:x,children:[(0,Z.jsx)(f.Button,{className:I,onClick:this.handleCancel,children:"取消"}),(0,Z.jsx)(f.Button,{className:I,onClick:this.handleConfirm,children:"确定"})]})]})}}]),i}(d.Component),w=(0,C.$j)((function(t){return{avatar:t.applyMiniapp.avatar}}))(T);Page((0,o.createPageConfig)(w,"subpackages/apply_miniapp/pages/img_cropper/index",{root:{cn:[]}},{}||{}))}},function(t){t.O(0,[2107,1216,8592],(function(){return e=63861,t(t.s=e);var e}));t.O()}]);